<!-- Advanced Customer Dashboard -->
<div class="modern-dashboard" [class]="'theme-' + trackingStyle">
  <!-- Top Navigation Bar -->
  <div class="dashboard-navbar">
    <div class="navbar-container">
      <div class="navbar-brand">
        <h1>ğŸš€ LivraXpress Dashboard</h1>
      </div>
      <div class="navbar-tabs">
        <button 
          class="nav-tab" 
          [class.active]="activeTab === 'home'"
          (click)="switchTab('home')"
        >
          <span class="icon">ğŸ </span>
          <span>Home</span>
        </button>
        <button 
          class="nav-tab" 
          [class.active]="activeTab === 'tracking'"
          (click)="switchTab('tracking')"
        >
          <span class="icon">ğŸ“</span>
          <span>Tracking</span>
        </button>
        <button 
          class="nav-tab" 
          [class.active]="activeTab === 'history'"
          (click)="switchTab('history')"
        >
          <span class="icon">ğŸ“‹</span>
          <span>History</span>
        </button>
        <button 
          class="nav-tab" 
          [class.active]="activeTab === 'loyalty'"
          (click)="switchTab('loyalty')"
        >
          <span class="icon">â­</span>
          <span>Loyalty</span>
        </button>
        <button 
          class="nav-tab" 
          [class.active]="activeTab === 'payments'"
          (click)="switchTab('payments')"
        >
          <span class="icon">ğŸ’³</span>
          <span>Payments</span>
        </button>
      </div>
      <div class="navbar-profile">
        <div class="profile-avatar">{{ currentUser?.nom_complet?.charAt(0) || 'U' }}</div>
      </div>
    </div>
  </div>

  <!-- Smart Notifications Banner -->
  <div class="smart-notifications">
    <div *ngFor="let notif of notifications" class="notification-toast" [class]="'notif-' + notif.type">
      <span class="notif-icon">{{ notif.message }}</span>
    </div>
  </div>

  <!-- HOME TAB -->
  <div class="dashboard-content" *ngIf="activeTab === 'home'">
    <!-- Welcome & Quick Stats -->
    <div class="welcome-section">
      <div class="welcome-header">
        <h2>Bienvenue, {{ currentUser?.nom_complet }}! ğŸ‘‹</h2>
        <p>Voici votre tableau de bord personnalisÃ©</p>
      </div>

      <!-- Key Metrics -->
      <div class="metrics-grid">
        <div class="metric-card metric-primary">
          <div class="metric-icon">ğŸ¯</div>
          <div class="metric-content">
            <span class="metric-value">{{ stats.montant_economise }} DH</span>
            <span class="metric-label">Ã‰conomisÃ©</span>
          </div>
        </div>
        <div class="metric-card metric-success">
          <div class="metric-icon">â±ï¸</div>
          <div class="metric-content">
            <span class="metric-value">{{ stats.temps_economise }}h</span>
            <span class="metric-label">Temps gagnÃ©</span>
          </div>
        </div>
        <div class="metric-card metric-info">
          <div class="metric-icon">ğŸ“¦</div>
          <div class="metric-content">
            <span class="metric-value">{{ stats.total_commandes }}</span>
            <span class="metric-label">Commandes</span>
          </div>
        </div>
        <div class="metric-card metric-warning">
          <div class="metric-icon">ğŸŒ±</div>
          <div class="metric-content">
            <span class="metric-value">{{ trackingStats.co2Saved }}kg</span>
            <span class="metric-label">COâ‚‚ Ã‰vitÃ©</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Recommendations Section -->
    <div class="section recommendations-section">
      <h3>ğŸ Recommendations personnalisÃ©es</h3>
      <div class="recommendations-carousel">
        <div *ngFor="let rec of recommendations" class="recommendation-card">
          <span class="rec-emoji">{{ rec.emoji }}</span>
          <p>{{ rec.text }}</p>
          <button class="btn-secondary">Explorer</button>
        </div>
      </div>
    </div>

    <!-- Active Orders with Real-time Tracking -->
    <div class="section active-orders">
      <h3>ğŸ“ Commandes en cours</h3>
      <div *ngIf="activeOrder" class="active-order-card">
        <!-- Driver Info -->
        <div class="driver-card">
          <img [src]="activeOrder.driver.avatar" [alt]="activeOrder.driver.nom" class="driver-avatar">
          <div class="driver-info">
            <h4>{{ activeOrder.driver.nom }}</h4>
            <p>ğŸ“Š {{ activeOrder.driver.stats.ordersDelivered }} livraisons â€¢ {{ activeOrder.driver.stats.satisfaction }}% satisfaction</p>
            <p class="vehicle-type">ğŸš— {{ activeOrder.driver.stats.vehicle }}</p>
            <p class="driver-message" *ngIf="activeOrder.driver.message">ğŸ’¬ "{{ activeOrder.driver.message }}"</p>
          </div>
        </div>

        <!-- Progress Timeline -->
        <div class="progress-timeline">
          <div class="timeline-step" [class.active]="activeOrder.status === 'preparation'">
            <div class="timeline-marker">ğŸ‘¨â€ğŸ³</div>
            <div class="timeline-label">PrÃ©paration</div>
          </div>
          <div class="timeline-connector"></div>
          <div class="timeline-step" [class.active]="activeOrder.status === 'pickup'">
            <div class="timeline-marker">ğŸª</div>
            <div class="timeline-label">RÃ©cupÃ©ration</div>
          </div>
          <div class="timeline-connector"></div>
          <div class="timeline-step" [class.active]="activeOrder.status === 'en_route'">
            <div class="timeline-marker">ğŸšš</div>
            <div class="timeline-label">En route</div>
          </div>
          <div class="timeline-connector"></div>
          <div class="timeline-step" [class.active]="activeOrder.status === 'delivered'">
            <div class="timeline-marker">âœ…</div>
            <div class="timeline-label">LivrÃ©e</div>
          </div>
        </div>

        <!-- ETA & Traffic Info -->
        <div class="eta-info">
          <div class="eta-item">
            <span class="eta-label">ArrivÃ©e estimÃ©e:</span>
            <span class="eta-value">{{ activeOrder.estimatedArrival | date:'HH:mm' }}</span>
          </div>
          <div class="eta-item">
            <span class="eta-label">Conditions:</span>
            <span class="eta-value">{{ getTrafficEmoji(activeOrder.trafficCondition) }} {{ activeOrder.trafficCondition }}</span>
          </div>
        </div>

        <!-- Quick Communication -->
        <div class="quick-messages">
          <button class="msg-btn" (click)="sendQuickMessage('Sonnez doucement')">ğŸ”” Sonner doucement</button>
          <button class="msg-btn" (click)="sendQuickMessage('Laisser Ã  la porte')">ğŸšª Laisser Ã  la porte</button>
          <button class="msg-btn" (click)="sendQuickMessage('J\'arrive bientÃ´t')">â³ ArrivÃ©e imminente</button>
          <button class="msg-btn" (click)="shareLocationWithDriver()">ğŸ“ Partager localisation</button>
        </div>
      </div>

      <div *ngIf="!activeOrder" class="empty-state">
        <p>Aucune commande en cours</p>
      </div>
    </div>

    <!-- Recent Orders -->
    <div class="section recent-orders">
      <h3>ğŸ“¦ Commandes rÃ©centes</h3>
      <div class="orders-list">
        <div *ngFor="let order of recentCommandes" class="order-item">
          <div class="order-header">
            <span class="order-number">#{{ order.numero_suivi }}</span>
            <span [class]="getStatusBadgeClass(order.statut)">{{ getStatusLabel(order.statut) }}</span>
          </div>
          <p class="order-restaurant">{{ order.fournisseur_nom }}</p>
          <p class="order-amount">{{ order.montant_total }} DH</p>
        </div>
      </div>
    </div>

    <!-- Favorites -->
    <div class="section favorites">
      <h3>â¤ï¸ Restaurants favoris</h3>
      <div class="favorites-grid">
        <div *ngFor="let fav of fournisseursFavoris" class="favorite-item">
          <img [src]="fav.photo_couverture" [alt]="fav.nom_entreprise">
          <div class="fav-info">
            <h4>{{ fav.nom_entreprise }}</h4>
            <p class="rating">â­ {{ fav.note_moyenne }} ({{ fav.nombre_avis }})</p>
            <p class="meta">{{ fav.temps_preparation_moyen }}min â€¢ {{ fav.frais_livraison }}DH</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TRACKING TAB -->
  <div class="dashboard-content" *ngIf="activeTab === 'tracking'">
    <div class="tracking-section">
      <h2>ğŸ“ Suivi en temps rÃ©el</h2>
      
      <div *ngIf="activeOrder" class="tracking-map-container">
        <!-- Map would go here (Leaflet integration) -->
        <div class="map-placeholder">
          <p>Carte interactive: {{ activeOrder.latitude }}, {{ activeOrder.longitude }}</p>
          <div class="map-controls">
            <button>ğŸ” Zoomer</button>
            <button>ğŸ“ Ma position</button>
            <button>ğŸ›¤ï¸ ItinÃ©raire</button>
          </div>
        </div>

        <!-- Driver Details -->
        <div class="tracking-details">
          <h3>Informations de livraison</h3>
          <div class="detail-row">
            <span>Livreur:</span>
            <strong>{{ activeOrder.driver.nom }}</strong>
          </div>
          <div class="detail-row">
            <span>VÃ©hicule:</span>
            <strong>{{ activeOrder.driver.stats.vehicle }}</strong>
          </div>
          <div class="detail-row">
            <span>ArrivÃ©e estimÃ©e:</span>
            <strong>{{ activeOrder.estimatedArrival | date:'HH:mm' }}</strong>
          </div>
          <div class="detail-row">
            <span>Condition du trafic:</span>
            <strong>{{ getTrafficEmoji(activeOrder.trafficCondition) }} {{ activeOrder.trafficCondition }}</strong>
          </div>
        </div>
      </div>

      <div *ngIf="!activeOrder" class="empty-state">
        <p>Aucune commande Ã  suivre actuellement</p>
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div class="dashboard-content" *ngIf="activeTab === 'history'">
    <div class="history-section">
      <h2>ğŸ“‹ Historique des commandes</h2>

      <!-- Filters -->
      <div class="filters">
        <input type="text" placeholder="ğŸ” Rechercher une commande...">
        <select>
          <option>Tous les types</option>
          <option>Restaurants</option>
          <option>Courses</option>
          <option>Pharmacie</option>
        </select>
        <select>
          <option>Tous les statuts</option>
          <option>LivrÃ©es</option>
          <option>En cours</option>
          <option>AnnulÃ©es</option>
        </select>
      </div>

      <!-- Orders Table -->
      <div class="orders-table">
        <div class="table-header">
          <div>Commande</div>
          <div>Restaurant</div>
          <div>Montant</div>
          <div>Date</div>
          <div>Statut</div>
        </div>
        <div *ngFor="let order of recentCommandes" class="table-row">
          <div>#{{ order.numero_suivi }}</div>
          <div>{{ order.fournisseur_nom }}</div>
          <div>{{ order.montant_total }} DH</div>
          <div>{{ order.date_commande | date:'short' }}</div>
          <div [class]="getStatusBadgeClass(order.statut)">{{ getStatusLabel(order.statut) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOYALTY TAB -->
  <div class="dashboard-content" *ngIf="activeTab === 'loyalty'">
    <div class="loyalty-section">
      <h2>â­ Programme de fidÃ©litÃ©</h2>

      <!-- Level Progress -->
      <div class="loyalty-level-card">
        <div class="level-display">
          <div class="level-icon">{{ loyaltyLevel.icon }}</div>
          <div class="level-info">
            <h3>{{ loyaltyLevel.level }} Level</h3>
            <p>Prochain niveau: {{ loyaltyLevel.nextLevel }}</p>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width]="loyaltyLevel.progress + '%'"></div>
        </div>
        <p class="progress-text">{{ loyaltyLevel.progress }}% de progression</p>
      </div>

      <!-- Badges -->
      <div class="badges-section">
        <h3>ğŸ† Badges dÃ©bloquÃ©s</h3>
        <div class="badges-grid">
          <div *ngFor="let badge of badges" class="badge-item" [class.locked]="!badge.achieved">
            <span class="badge-icon">{{ badge.icon }}</span>
            <p>{{ badge.name }}</p>
            <p class="badge-status">{{ badge.achieved ? 'DÃ©bloquÃ©' : 'VerrouillÃ©' }}</p>
          </div>
        </div>
      </div>

      <!-- Rewards Wheel -->
      <div class="rewards-wheel-section">
        <h3>ğŸ¡ Roue des rÃ©compenses</h3>
        <p>Vous avez {{ stats.total_commandes }} commandes - vous pouvez tourner la roue!</p>
        <button class="spin-button" (click)="spinRewardsWheel()">ğŸ° TOURNER LA ROUE!</button>
      </div>
    </div>
  </div>

  <!-- PAYMENTS TAB -->
  <div class="dashboard-content" *ngIf="activeTab === 'payments'">
    <div class="payments-section">
      <h2>ğŸ’³ Gestion des paiements</h2>

      <!-- Virtual Wallet -->
      <div class="wallet-card">
        <div class="wallet-header">
          <h3>ğŸ’° Portefeuille virtuel</h3>
          <span class="balance">Solde: 500 DH</span>
        </div>
        <div class="wallet-actions">
          <button class="btn-primary">Recharger</button>
          <button class="btn-secondary">Historique</button>
        </div>
      </div>

      <!-- Monthly Spending Tracker -->
      <div class="spending-card">
        <h3>ğŸ“Š DÃ©penses mensuelles</h3>
        <div class="spending-stats">
          <div class="stat">
            <span class="stat-label">DÃ©cembre 2024</span>
            <span class="stat-value">{{ getMonthlySpending() }} DH</span>
          </div>
          <div class="stat">
            <span class="stat-label">Moyenne/commande</span>
            <span class="stat-value">{{ (getMonthlySpending() / stats.total_commandes) | number:'1.0-0' }} DH</span>
          </div>
        </div>
      </div>

      <!-- Payment Methods -->
      <div class="payment-methods">
        <h3>ğŸ’³ MÃ©thodes de paiement</h3>
        <div class="method-list">
          <div class="method-item">
            <span class="method-icon">ğŸ’³</span>
            <span class="method-name">Carte bancaire - **** 4242</span>
            <span class="method-default">DÃ©faut</span>
          </div>
          <div class="method-item">
            <span class="method-icon">ğŸ“±</span>
            <span class="method-name">Mobile Money</span>
          </div>
        </div>
      </div>

      <!-- Split Payment & Pay Later -->
      <div class="payment-options">
        <button class="option-btn" (click)="toggleSplitPayment()">
          <span>â—</span>
          <span>Paiement fractionnÃ©</span>
        </button>
        <button class="option-btn">
          <span>â°</span>
          <span>Payer plus tard</span>
        </button>
        <button class="option-btn">
          <span>ğŸ“…</span>
          <span>Abonnement fidÃ©litÃ©</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Environmental Impact Indicator (Sidebar) -->
  <div class="environmental-sidebar">
    <h4>ğŸŒ± Impact environnemental</h4>
    <div class="eco-stat">
      <span>Distance Ã©conomisÃ©e:</span>
      <strong>{{ trackingStats.distanceTraveled }} km</strong>
    </div>
    <div class="eco-stat">
      <span>COâ‚‚ Ã©vitÃ©:</span>
      <strong>{{ calculateCO2Saved() }} kg</strong>
    </div>
    <button class="eco-button" (click)="offsetCO2Emissions()">Compenser les Ã©missions</button>
    <p class="eco-badge">Recommandations Ã©co-responsables disponibles â™»ï¸</p>
  </div>
</div>
